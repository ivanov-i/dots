#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const os = require('os');
const { execSync } = require('child_process');

// Paths
const homeDir = os.homedir();
const skillsDir = path.join(homeDir, '.codex', 'skills');
const bootstrapFile = path.join(homeDir, '.codex', 'superpowers-bootstrap.md');

function extractFrontmatter(filePath) {
    try {
        const content = fs.readFileSync(filePath, 'utf8');
        const lines = content.split('\n');

        let inFrontmatter = false;
        let name = '';
        let description = '';
        let whenToUse = '';

        for (const line of lines) {
            if (line.trim() === '---') {
                if (inFrontmatter) break;
                inFrontmatter = true;
                continue;
            }

            if (inFrontmatter) {
                const match = line.match(/^(\w+):\s*(.*)$/);
                if (match) {
                    const [, key, value] = match;
                    switch (key) {
                        case 'name': name = value.trim(); break;
                        case 'description': description = value.trim(); break;
                        case 'when_to_use': whenToUse = value.trim(); break;
                    }
                }
            }
        }

        return { name, description, whenToUse };
    } catch (error) {
        return { name: '', description: '', whenToUse: '' };
    }
}

function printSkill(skillPath) {
    const skillFile = path.join(skillPath, 'SKILL.md');
    const relPath = path.relative(skillsDir, skillPath)

    // Print skill name with namespace
        console.log(relPath.replace(/\\/g, '/'));

    // Extract and print metadata
    const { name, description, whenToUse } = extractFrontmatter(skillFile);

    if (description) console.log(`  ${description}`);
    if (whenToUse) console.log(`  When to use: ${whenToUse}`);
    console.log('');
}

function findSkillsInDir(dir, maxDepth) {
    const skills = [];

    if (!fs.existsSync(dir)) return skills;

    function searchDir(currentDir, currentDepth) {
        if (currentDepth > maxDepth) return;

        try {
            const entries = fs.readdirSync(currentDir, { withFileTypes: true });

            for (const entry of entries) {
                if (entry.isDirectory()) {
                    const skillDir = path.join(currentDir, entry.name);
                    const skillFile = path.join(skillDir, 'SKILL.md');

                    if (fs.existsSync(skillFile)) {
                        skills.push(skillDir);
                    }

                        searchDir(skillDir, currentDepth + 1);
                }
            }
        } catch (error) {
            // Ignore permission errors or other issues
        }
    }

    searchDir(dir, 0);
    return skills;
}

// Commands
function runFindSkills() {
    console.log('Available skills:');
    console.log('==================');
    console.log('');

    const foundSkills = new Set();

    const skills = findSkillsInDir(skillsDir, 2);
    for (const skillPath of skills) {
        const relPath = path.relative(skillsDir, skillPath);
        foundSkills.add(relPath);
        printSkill(skillPath);
    }

    console.log('Usage:');
    console.log('  superpowers-codex use-skill <skill-name>   # Load a specific skill');
    console.log('');
    console.log('Note: All skills are disclosed at session start via bootstrap.');
}

function runBootstrap() {
    console.log('# Superpowers Bootstrap for Codex');
    console.log('# ================================');
    console.log('');

    // Show the bootstrap instructions
    if (fs.existsSync(bootstrapFile)) {
        console.log('## Bootstrap Instructions:');
        console.log('');
        try {
            const content = fs.readFileSync(bootstrapFile, 'utf8');
            console.log(content);
        } catch (error) {
            console.log(`Error reading bootstrap file: ${error.message}`);
        }
        console.log('');
        console.log('---');
        console.log('');
    }

    runFindSkills();

    console.log('');
    console.log('---');
    console.log('');

    // Load the using-superpowers skill automatically
    console.log('## Auto-loading using-superpowers skill:');
    console.log('');
    runUseSkill('using-superpowers');

    console.log('');
    console.log('---');
    console.log('');
    console.log('# Bootstrap Complete!');
    console.log('# You now have access to all superpowers skills.');
    console.log('# Use "superpowers-codex use-skill <skill>" to load and apply skills.');
    console.log('# Remember: If a skill applies to your task, you MUST use it!');
}

function runUseSkill(skillName) {
    if (!skillName) {
        console.log('Usage: superpowers-codex use-skill <skill-name>');
        console.log('Examples:');
        console.log('  superpowers-codex use-skill brainstorming');
        console.log('  superpowers-codex use-skill my-custom-skill');
        return;
    }

    // Handle namespaced skill names
    let actualSkillPath;
    actualSkillPath = skillName;

    // Remove "skills/" prefix if present
    if (actualSkillPath.startsWith('skills/')) {
        actualSkillPath = actualSkillPath.substring('skills/'.length);
    }

    // Function to find skill file
    function findSkillFile(searchPath) {
        // Check for exact match with SKILL.md
        const skillMdPath = path.join(searchPath, 'SKILL.md');
        if (fs.existsSync(skillMdPath)) {
            return skillMdPath;
        }

        // Check for direct SKILL.md file
        if (searchPath.endsWith('SKILL.md') && fs.existsSync(searchPath)) {
            return searchPath;
        }

        return null;
    }

    let skillFile = null;

        if (fs.existsSync(skillsDir)) {
            const fullSkillPath = path.join(skillsDir, actualSkillPath);
            skillFile = findSkillFile(fullSkillPath);
            if (skillFile) {
                console.log(`# Loading skill: ${actualSkillPath}`);
                console.log(`# Source: ${skillFile}`);
                console.log('');
            }
        }


    // If still not found, error
    if (!skillFile) {
        console.log(`Error: Skill not found: ${actualSkillPath}`);
        console.log('');
        console.log('Available skills:');
        runFindSkills();
        return;
    }

    // Extract frontmatter and content
    let content, frontmatter;
    try {
        const fullContent = fs.readFileSync(skillFile, 'utf8');
        const { name, description, whenToUse } = extractFrontmatter(skillFile);

        // Extract just the content after frontmatter
        const lines = fullContent.split('\n');
        let inFrontmatter = false;
        let frontmatterEnded = false;
        const contentLines = [];

        for (const line of lines) {
            if (line.trim() === '---') {
                if (inFrontmatter) {
                    frontmatterEnded = true;
                    continue;
                }
                inFrontmatter = true;
                continue;
            }

            if (frontmatterEnded || !inFrontmatter) {
                contentLines.push(line);
            }
        }

        content = contentLines.join('\n').trim();
        frontmatter = { name, description, whenToUse };
    } catch (error) {
        console.log(`Error reading skill file: ${error.message}`);
        return;
    }

    // Display skill header with clean info
    const displayName = actualSkillPath

    const skillDirectory = path.dirname(skillFile);

    console.log(`# ${frontmatter.name || displayName}`);
    if (frontmatter.description) {
        console.log(`# ${frontmatter.description}`);
    }
    if (frontmatter.whenToUse) {
        console.log(`# When to use: ${frontmatter.whenToUse}`);
    }
    console.log(`# Supporting tools and docs are in ${skillDirectory}`);
    console.log('# ============================================');
    console.log('');

    // Display the skill content (without frontmatter)
    console.log(content);

}

function printUsage() {
    console.log('Usage: superpowers-codex <command> [arguments]');
    console.log('');
    console.log('Commands:');
    console.log('  bootstrap              # Run complete bootstrap with all skills');
    console.log('  use-skill <skill-name> # Load a specific skill');
    console.log('  find-skills            # List all available skills');
    console.log('');
    console.log('Examples:');
    console.log('  superpowers-codex bootstrap');
    console.log('  superpowers-codex use-skill brainstorming');
    console.log('  superpowers-codex use-skill my-custom-skill');
}

// Main CLI
const command = process.argv[2];
const arg = process.argv[3];

switch (command) {
    case 'bootstrap':
        runBootstrap();
        break;
    case 'use-skill':
        runUseSkill(arg);
        break;
    case 'find-skills':
        runFindSkills();
        break;
    default:
        printUsage();
        break;
}
